INF = int(1e15)

network_time_dict = {
    ('H100','allreduce', 2): {
        32: 0.04,
        64: 0.04,
        128: 0.04,
        256: 0.04,
        512: 0.04,
        1024: 0.04,
        2048: 0.04,
        4096: 0.04,
        8192: 0.04,
        16384: 0.04,
        32768: 0.04,
        65536: 0.04,
        131072: 0.04,
        262144: 0.04,
        524288: 0.05,
        1048576: 0.06,
        2097152: 0.06,
        4194304: 0.07,
        8388608: 0.1,
        16777216: 0.17,
        33554432: 0.28,
        67108864: 0.49,
        134217728: 0.91,
        268435456: 1.71,
        536870912: 3.27,
        1073741824: 6.32,
        2147483648: 12.43,
        4294967296: 24.94,
        8589934592: 49.21,
        17179869184: 98.21
    },
    ('H100','allreduce', 4): {
        32: 0.08,
        64: 0.08,
        128: 0.08,
        256: 0.08,
        512: 0.08,
        1024: 0.08,
        2048: 0.08,
        4096: 0.08,
        8192: 0.08,
        16384: 0.08,
        32768: 0.08,
        65536: 0.08,
        131072: 0.09,
        262144: 0.1,
        524288: 0.08,
        1048576: 0.16,
        2097152: 0.21,
        4194304: 0.1,
        8388608: 0.2,
        16777216: 0.21,
        33554432: 0.35,
        67108864: 0.78,
        134217728: 1.3,
        268435456: 2.33,
        536870912: 4.54,
        1073741824: 8.94,
        2147483648: 17.77,
        4294967296: 35.35,
        8589934592: 70.59,
        17179869184: 140.53
    },
    ('H100','allreduce', 8): {
        32: 0.22,
        64: 0.23,
        128: 0.25,
        256: 0.2,
        512: 0.16,
        1024: 0.11,
        2048: 0.08,
        4096: 0.05,
        8192: 0.05,
        16384: 0.05,
        32768: 0.05,
        65536: 0.05,
        131072: 0.05,
        262144: 0.71,
        524288: 0.54,
        1048576: 0.58,
        2097152: 0.67,
        4194304: 0.63,
        8388608: 0.63,
        16777216: 0.7,
        33554432: 0.71,
        67108864: 0.69,
        134217728: 1.14,
        268435456: 2.13,
        536870912: 4.09,
        1073741824: 8.07,
        2147483648: 15.83,
        4294967296: 31.45,
        8589934592: 62.93,
        17179869184: 125.28
    },
    ('H100','allgather', 2): {
        32: 0.12,
        64: 0.14,
        128: 0.11,
        256: 0.13,
        512: 0.12,
        1024: 0.1,
        2048: 0.1,
        4096: 0.1,
        8192: 0.09,
        16384: 0.1,
        32768: 0.1,
        65536: 0.09,
        131072: 0.25,
        262144: 0.27,
        524288: 0.25,
        1048576: 0.19,
        2097152: 0.25,
        4194304: 0.33,
        8388608: 0.37,
        16777216: 0.38,
        33554432: 0.64,
        67108864: 0.87,
        134217728: 1.53,
        268435456: 2.84,
        536870912: 5.38,
        1073741824: 10.37,
        2147483648: 45.1,
        4294967296: 145.34,
        8589934592: 314.83
    },
    ('H100','allgather', 4): {
        32: 0.12,
        64: 0.11,
        128: 0.11,
        256: 0.1,
        512: 0.1,
        1024: 0.1,
        2048: 0.1,
        4096: 0.12,
        8192: 0.11,
        16384: 0.11,
        32768: 0.12,
        65536: 0.41,
        131072: 0.63,
        262144: 0.42,
        524288: 0.51,
        1048576: 0.54,
        2097152: 0.68,
        4194304: 1.35,
        8388608: 0.92,
        16777216: 0.8,
        33554432: 3.09,
        67108864: 5.33,
        134217728: 3.3,
        268435456: 6.49,
        536870912: 11.85,
        1073741824: 23.12,
        2147483648: 107.77,
        4294967296: 282.06,
        8589934592: 701.06
    },
    ('H100','allgather', 8): {
        32: 0.14,
        64: 0.13,
        128: 0.22,
        256: 0.13,
        512: 0.2,
        1024: 0.12,
        2048: 0.21,
        4096: 0.18,
        8192: 0.14,
        16384: 0.17,
        32768: 0.14,
        65536: 1.46,
        131072: 0.86,
        262144: 0.57,
        524288: 0.72,
        1048576: 1.14,
        2097152: 1.16,
        4194304: 1.27,
        8388608: 1.37,
        16777216: 1.68,
        33554432: 2.5,
        67108864: 4.01,
        134217728: 7.65,
        268435456: 13.25,
        536870912: 25.87,
        1073741824: 109.26,
        2147483648: 304.8,
        4294967296: 969.17
    }
}

def get_allreduce_time(x: int, tp: int) -> float:
    if tp == 1:
        return 0
    key = ('H100', 'allreduce', tp)
    if key not in network_time_dict:
        return 0
    scoped_time = network_time_dict[key]
    y = x
    
    if y < min(scoped_time.keys()):
        return scoped_time[min(scoped_time.keys())]
    
    if y > max(scoped_time.keys()):
        return scoped_time[max(scoped_time.keys())] * (y / max(scoped_time.keys()))
    
    if y in scoped_time:
        return scoped_time[y]
    
    # interpolate if not exists
    lower_key = max(k for k in scoped_time.keys() if k <= y)
    upper_key = min(k for k in scoped_time.keys() if k >= y)

    lower_time = scoped_time[lower_key]
    upper_time = scoped_time[upper_key]
    
    return lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)


def get_allgather_time(x: int, cp: int) -> float:
    if cp == 1:
        return 0
    
    key = ('H100', 'allgather', cp)
    if key not in network_time_dict:
        return 0
    scoped_time = network_time_dict[key]
    y = x
    
    if y < min(scoped_time.keys()):
        return scoped_time[min(scoped_time.keys())]
    
    if y > max(scoped_time.keys()):
        return scoped_time[max(scoped_time.keys())] * (y / max(scoped_time.keys()))
    
    if y in scoped_time:
        return scoped_time[y]
    
    # interpolate if not exists
    lower_key = max(k for k in scoped_time.keys() if k <= y)
    upper_key = min(k for k in scoped_time.keys() if k >= y)

    lower_time = scoped_time[lower_key]
    upper_time = scoped_time[upper_key]
    
    return lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)
    pass
