


# export EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 
# export SHOULD_RESEND_QKV=1 
# export EXPERIMENT_WARMUP_TIMEOUT_SEC=300 
# export EXPERIMENT_WARMUP_TIMES=3 
# export EXPERIMENT_REPEAT_TIMES=3 
# export EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=6 
# export NUM_LAYERS=32
# export EXPERIMENT_LOG_MEMORY_USAGE=1

# export DRY_RUN=1 # Just showing the srun command to run...

# for NNODES in 32 16 8; do
#     for NUM_TOKENS in 131072 262144 524288 1048576; do
#         # define BATCH_SIZE
        
#         if [ $NUM_TOKENS -eq 131072 ]; then
#             BATCH_SIZE=$((4 * NNODES))
#         elif [ $NUM_TOKENS -eq 262144 ]; then
#             BATCH_SIZE=$((2 * NNODES))
#         elif [ $NUM_TOKENS -eq 524288 ]; then
#             BATCH_SIZE=$((1 * NNODES))
#         elif [ $NUM_TOKENS -eq 1048576 ]; then
#             BATCH_SIZE=$((1 * NNODES))
#         else
#             BATCH_SIZE=1
#         fi

#         ELONGATE_FACTOR=$((NUM_TOKENS / 65536))
#         NGPUS=$((NNODES * 8))
#         NNODES=$NNODES NGPUS=$NGPUS BATCH_SIZE=$BATCH_SIZE NUM_TOKENS=$NUM_TOKENS ELONGATE_FACTOR=$ELONGATE_FACTOR MAX_SAMPLE_ID=3 bash /mnt/weka/home/yonghao.zhuang/jd/d2/benchmarks/_250904_large_scale_v5/srun_one_case.sh
#     done
# done

# # EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 SHOULD_RESEND_QKV=1 EXPERIMENT_WARMUP_TIMEOUT_SEC=300 EXPERIMENT_WARMUP_TIMES=3 EXPERIMENT_REPEAT_TIMES=1 EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=6 EXPERIMENT_LOG_MEMORY_USAGE=1 BATCH_SIZE=2 NUM_LAYERS=32 NUM_TOKENS=1048576 ELONGATE_FACTOR=16 MAX_SAMPLE_ID=3 bash test_e2e_combined.onesrun.sh


export CUDA_LAUNCH_BLOCKING=true
export NCCL_DEBUG=INFO




# âšª Ready: 128k BS16 ?GB
EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 SHOULD_RESEND_QKV=1 EXPERIMENT_WARMUP_TIMEOUT_SEC=300 EXPERIMENT_WARMUP_TIMES=3 EXPERIMENT_REPEAT_TIMES=1 EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=3 EXPERIMENT_LOG_MEMORY_USAGE=1 BATCH_SIZE=32 NUM_LAYERS=32 NUM_TOKENS=131072 ELONGATE_FACTOR=16 MAX_SAMPLE_ID=3 bash test_e2e_combined.onesrun.sh


# âšª Ready: 256k BS8 ?GB
EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 SHOULD_RESEND_QKV=1 EXPERIMENT_WARMUP_TIMEOUT_SEC=300 EXPERIMENT_WARMUP_TIMES=3 EXPERIMENT_REPEAT_TIMES=1 EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=2 EXPERIMENT_LOG_MEMORY_USAGE=1 BATCH_SIZE=8 NUM_LAYERS=32 NUM_TOKENS=262144 ELONGATE_FACTOR=4 MAX_SAMPLE_ID=3 bash test_e2e_combined.onesrun.sh


# ðŸŸ¢ Ready: 512k BS4 83GB @ loss
EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 SHOULD_RESEND_QKV=1 EXPERIMENT_WARMUP_TIMEOUT_SEC=300 EXPERIMENT_WARMUP_TIMES=3 EXPERIMENT_REPEAT_TIMES=1 EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=3 EXPERIMENT_LOG_MEMORY_USAGE=1 BATCH_SIZE=4 NUM_LAYERS=32 NUM_TOKENS=524288 ELONGATE_FACTOR=8 MAX_SAMPLE_ID=3 bash test_e2e_combined.onesrun.sh


# ðŸŸ¢ Pass: 1M BS4 105GB @ loss
EXPERIMENT_DEBUG_SET_METADATA_TRANSFER_SIZE_TO_0=0 SHOULD_RESEND_QKV=1 EXPERIMENT_WARMUP_TIMEOUT_SEC=300 EXPERIMENT_WARMUP_TIMES=3 EXPERIMENT_REPEAT_TIMES=1 EXPERIMENT_NVSHMEM_BUFFER_SIZE_GB=3 EXPERIMENT_LOG_MEMORY_USAGE=1 BATCH_SIZE=4 NUM_LAYERS=32 NUM_TOKENS=1048576 ELONGATE_FACTOR=16 MAX_SAMPLE_ID=3 bash test_e2e_combined.onesrun.sh