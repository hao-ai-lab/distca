# TODO: Add more models.

INF = int(1e15)

def get_mlp_time(x: int, tp: int, cp: int) -> float:
    # length -> time ms
    unit_time = {
        64:10.96,
        128:11.68,
        256:11.01,
        512:13.24,
        1024:11.46,
        2048:12.56,
        4096:13.87,
        8192:17.79,
        16384:25.86,
        32768:44.25,
        65536:76.6,
        131072:153.2,
        262144:306.4,
        524288:612.8
    }

    
    y = x / (tp * cp)
    # Find the two closest keys to y
    sorted_keys = list(unit_time.keys())
    # This is guaranteed to be sorted anyways.

    if y < 64:
        return unit_time[64]
    elif y > 524288:
        return unit_time[524288] / 524288 * y
    
    # If y is an exact match, return immediately
    if y in unit_time:
        z = unit_time[y]
    else:
        # Find the two closest keys
        lower_key = max(k for k in sorted_keys if k <= y)
        upper_key = min(k for k in sorted_keys if k >= y)
        
        # Linear interpolation
        lower_time = unit_time[lower_key]
        upper_time = unit_time[upper_key]
        
        # Interpolate
        z = lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)
    return z



def get_attn_time(
    x: int, tp: int, cp: int,
    hqo: int = 64, hkv: int = 4, d: int = 128,
) -> float:
    unit_time = {
        (1, 1): {
            128: 0.06,
            256: 0.06,
            512: 0.08,
            1024: 0.16,
            2048: 0.31,
            4096: 0.92,
            8192: 3.13,
            16384: 11.85,
            32768: 46.51,
            49152: 111.39,
            65536: 195.51,
            98304: 463.5,
            131072: 842.39
        },
        (1, 2): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.09,
            2048: 0.19,
            4096: 0.51,
            8192: 1.63,
            16384: 5.96,
            32768: 23.49,
            49152: 54.38,
            65536: 97.41,
            98304: 227.86,
            131072: 417.1
        },
        (1, 4): {
            128: 0.06,
            256: 0.07,
            512: 0.06,
            1024: 0.07,
            2048: 0.11,
            4096: 0.28,
            8192: 0.88,
            16384: 3.05,
            32768: 11.83,
            49152: 27.39,
            65536: 47.17,
            98304: 114.07,
            131072: 207.66
        },
        (1, 8): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.08,
            4096: 0.16,
            8192: 0.47,
            16384: 1.59,
            32768: 5.93,
            49152: 13.68,
            65536: 23.56,
            98304: 55.54,
            131072: 103.4
        },
        (2, 1): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.1,
            2048: 0.21,
            4096: 0.53,
            8192: 1.71,
            16384: 6.06,
            32768: 23.59,
            49152: 55.79,
            65536: 98.18,
            98304: 232.67,
            131072: 422.24
        },
        (2, 2): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.08,
            2048: 0.12,
            4096: 0.31,
            8192: 0.93,
            16384: 3.16,
            32768: 11.82,
            49152: 27.37,
            65536: 47.03,
            98304: 115.53,
            131072: 208.96
        },
        (2, 4): {
            128: 0.06,
            256: 0.07,
            512: 0.06,
            1024: 0.07,
            2048: 0.09,
            4096: 0.17,
            8192: 0.51,
            16384: 1.69,
            32768: 6.03,
            49152: 14.15,
            65536: 23.83,
            98304: 56.88,
            131072: 104.16
        },
        (2, 8): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.08,
            4096: 0.11,
            8192: 0.27,
            16384: 0.86,
            32768: 3.09,
            49152: 6.96,
            65536: 11.9,
            98304: 27.88,
            131072: 50.74
        },
        (4, 1): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.08,
            2048: 0.15,
            4096: 0.35,
            8192: 0.98,
            16384: 3.26,
            32768: 12.13,
            49152: 27.47,
            65536: 47.74,
            98304: 116.77,
            131072: 212.28
        },
        (4, 2): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.08,
            2048: 0.1,
            4096: 0.19,
            8192: 0.56,
            16384: 1.76,
            32768: 6.17,
            49152: 13.9,
            65536: 23.9,
            98304: 56.39,
            131072: 104.8
        },
        (4, 4): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.09,
            4096: 0.12,
            8192: 0.29,
            16384: 0.93,
            32768: 3.21,
            49152: 7.03,
            65536: 12.22,
            98304: 28.02,
            131072: 51.52
        },
        (4, 8): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.08,
            4096: 0.11,
            8192: 0.18,
            16384: 0.48,
            32768: 1.65,
            49152: 3.52,
            65536: 6.09,
            98304: 14.38,
            131072: 25.25
        },
        (8, 1): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.08,
            2048: 0.11,
            4096: 0.24,
            8192: 0.63,
            16384: 1.87,
            32768: 6.37,
            49152: 14.06,
            65536: 24.21,
            98304: 58.44,
            131072: 107.35
        },
        (8, 2): {
            128: 0.06,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.09,
            4096: 0.14,
            8192: 0.34,
            16384: 1.05,
            32768: 3.42,
            49152: 7.23,
            65536: 12.33,
            98304: 28.28,
            131072: 51.82
        },
        (8, 4): {
            128: 0.07,
            256: 0.06,
            512: 0.06,
            1024: 0.07,
            2048: 0.09,
            4096: 0.12,
            8192: 0.2,
            16384: 0.52,
            32768: 1.82,
            49152: 3.66,
            65536: 6.39,
            98304: 14.51,
            131072: 25.97
        },
        (8, 8): {
            128: 0.06,
            256: 0.06,
            512: 0.07,
            1024: 0.07,
            2048: 0.08,
            4096: 0.12,
            8192: 0.18,
            16384: 0.31,
            32768: 0.89,
            49152: 2.26,
            65536: 3.23,
            98304: 6.94,
            131072: 12.99
        }
    }

    scoped_time = unit_time[(tp, cp)]
    # y = x / (tp * cp)
    y = x
    
    if y < 128:
        return scoped_time[128]
    
    if y > 131072:
        return scoped_time[131072] * (y / 131072) ** 2
    
    if y in scoped_time:
        return scoped_time[y]
    
    
    # TODO: May be slow.
    # interpolate if not exists.
    lower_key = max(k for k in scoped_time.keys() if k <= y)
    upper_key = min(k for k in scoped_time.keys() if k >= y)

    lower_time = scoped_time[lower_key]
    upper_time = scoped_time[upper_key]
    
    result = lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)
    return result




network_time_dict = {
    ('H100','allreduce', 2): {
        32: 0.04,
        64: 0.04,
        128: 0.04,
        256: 0.04,
        512: 0.04,
        1024: 0.04,
        2048: 0.04,
        4096: 0.04,
        8192: 0.04,
        16384: 0.04,
        32768: 0.04,
        65536: 0.04,
        131072: 0.04,
        262144: 0.04,
        524288: 0.05,
        1048576: 0.06,
        2097152: 0.06,
        4194304: 0.07,
        8388608: 0.1,
        16777216: 0.17,
        33554432: 0.28,
        67108864: 0.49,
        134217728: 0.91,
        268435456: 1.71,
        536870912: 3.27,
        1073741824: 6.32,
        2147483648: 12.43,
        4294967296: 24.94,
        8589934592: 49.21,
        17179869184: 98.21
    },
    ('H100','allreduce', 4): {
        32: 0.08,
        64: 0.08,
        128: 0.08,
        256: 0.08,
        512: 0.08,
        1024: 0.08,
        2048: 0.08,
        4096: 0.08,
        8192: 0.08,
        16384: 0.08,
        32768: 0.08,
        65536: 0.08,
        131072: 0.09,
        262144: 0.1,
        524288: 0.08,
        1048576: 0.16,
        2097152: 0.21,
        4194304: 0.1,
        8388608: 0.2,
        16777216: 0.21,
        33554432: 0.35,
        67108864: 0.78,
        134217728: 1.3,
        268435456: 2.33,
        536870912: 4.54,
        1073741824: 8.94,
        2147483648: 17.77,
        4294967296: 35.35,
        8589934592: 70.59,
        17179869184: 140.53
    },
    ('H100','allreduce', 8): {
        32: 0.22,
        64: 0.23,
        128: 0.25,
        256: 0.2,
        512: 0.16,
        1024: 0.11,
        2048: 0.08,
        4096: 0.05,
        8192: 0.05,
        16384: 0.05,
        32768: 0.05,
        65536: 0.05,
        131072: 0.05,
        262144: 0.71,
        524288: 0.54,
        1048576: 0.58,
        2097152: 0.67,
        4194304: 0.63,
        8388608: 0.63,
        16777216: 0.7,
        33554432: 0.71,
        67108864: 0.69,
        134217728: 1.14,
        268435456: 2.13,
        536870912: 4.09,
        1073741824: 8.07,
        2147483648: 15.83,
        4294967296: 31.45,
        8589934592: 62.93,
        17179869184: 125.28
    },
    ('H100','allgather', 2): {
        32: 0.12,
        64: 0.14,
        128: 0.11,
        256: 0.13,
        512: 0.12,
        1024: 0.1,
        2048: 0.1,
        4096: 0.1,
        8192: 0.09,
        16384: 0.1,
        32768: 0.1,
        65536: 0.09,
        131072: 0.25,
        262144: 0.27,
        524288: 0.25,
        1048576: 0.19,
        2097152: 0.25,
        4194304: 0.33,
        8388608: 0.37,
        16777216: 0.38,
        33554432: 0.64,
        67108864: 0.87,
        134217728: 1.53,
        268435456: 2.84,
        536870912: 5.38,
        1073741824: 10.37,
        2147483648: 45.1,
        4294967296: 145.34,
        8589934592: 314.83
    },
    ('H100','allgather', 4): {
        32: 0.12,
        64: 0.11,
        128: 0.11,
        256: 0.1,
        512: 0.1,
        1024: 0.1,
        2048: 0.1,
        4096: 0.12,
        8192: 0.11,
        16384: 0.11,
        32768: 0.12,
        65536: 0.41,
        131072: 0.63,
        262144: 0.42,
        524288: 0.51,
        1048576: 0.54,
        2097152: 0.68,
        4194304: 1.35,
        8388608: 0.92,
        16777216: 0.8,
        33554432: 3.09,
        67108864: 5.33,
        134217728: 3.3,
        268435456: 6.49,
        536870912: 11.85,
        1073741824: 23.12,
        2147483648: 107.77,
        4294967296: 282.06,
        8589934592: 701.06
    },
    ('H100','allgather', 8): {
        32: 0.14,
        64: 0.13,
        128: 0.22,
        256: 0.13,
        512: 0.2,
        1024: 0.12,
        2048: 0.21,
        4096: 0.18,
        8192: 0.14,
        16384: 0.17,
        32768: 0.14,
        65536: 1.46,
        131072: 0.86,
        262144: 0.57,
        524288: 0.72,
        1048576: 1.14,
        2097152: 1.16,
        4194304: 1.27,
        8388608: 1.37,
        16777216: 1.68,
        33554432: 2.5,
        67108864: 4.01,
        134217728: 7.65,
        268435456: 13.25,
        536870912: 25.87,
        1073741824: 109.26,
        2147483648: 304.8,
        4294967296: 969.17
    }
}
def get_allreduce_time(x: int, tp: int) -> float:
    if tp == 1:
        return 0
    key = ('H100', 'allreduce', tp)
    if key not in network_time_dict:
        return 0
    scoped_time = network_time_dict[key]
    y = x
    
    if y < min(scoped_time.keys()):
        return scoped_time[min(scoped_time.keys())]
    
    if y > max(scoped_time.keys()):
        return scoped_time[max(scoped_time.keys())] * (y / max(scoped_time.keys()))
    
    if y in scoped_time:
        return scoped_time[y]
    
    # interpolate if not exists
    lower_key = max(k for k in scoped_time.keys() if k <= y)
    upper_key = min(k for k in scoped_time.keys() if k >= y)

    lower_time = scoped_time[lower_key]
    upper_time = scoped_time[upper_key]
    
    return lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)


def get_allgather_time(x: int, cp: int) -> float:
    if cp == 1:
        return 0
    
    key = ('H100', 'allgather', cp)
    if key not in network_time_dict:
        return 0
    scoped_time = network_time_dict[key]
    y = x
    
    if y < min(scoped_time.keys()):
        return scoped_time[min(scoped_time.keys())]
    
    if y > max(scoped_time.keys()):
        return scoped_time[max(scoped_time.keys())] * (y / max(scoped_time.keys()))
    
    if y in scoped_time:
        return scoped_time[y]
    
    # interpolate if not exists
    lower_key = max(k for k in scoped_time.keys() if k <= y)
    upper_key = min(k for k in scoped_time.keys() if k >= y)

    lower_time = scoped_time[lower_key]
    upper_time = scoped_time[upper_key]
    
    return lower_time + (upper_time - lower_time) * (y - lower_key) / (upper_key - lower_key)
    pass
